-- Recent Articles Query
--
-- Returns recent articles with their associated tags,
-- ordered by publication date (newest first).
-- Articles are filtered by publication date and optionally by tag.
--
-- Binds:
--   ::since - (optional) Only include articles published on or after this date.
--             Defaults to 6 months ago if not provided.
--   ::tag   - (optional) Filter to articles having a tag matching this pattern
--             (uses SQL LIKE matching). Pass NULL or omit to include all tags.
--
-- Columns returned:
--   id           - Article ID
--   title        - Article title
--   published_on - Publication date
--   url          - Article URL
--   tags         - JSON array of tag names
--   tags_str     - Comma-separated list of tags (sorted alphabetically)

WITH settings(published_since) as (
  values(COALESCE(:since, datetime('now', '-6 months')))
),

recent_articles(article_id, article_title, article_published_on, article_url) AS (
  SELECT id, title, published_on, url
  FROM articles
  RIGHT JOIN settings
  WHERE published_on >= settings.published_since
),

tags_by_article(article_id, tags) AS (
  SELECT articles_tags.article_id,
    json_group_array(tags.name) AS tags
  FROM articles_tags
  JOIN tags ON articles_tags.tag_id = tags.id
  GROUP BY articles_tags.article_id
)

SELECT recent_articles.article_id AS id,
       recent_articles.article_title AS title,
       recent_articles.article_published_on AS published_on,
       recent_articles.article_url AS url,
       tags,
       group_concat(json_each.value, ',' ORDER BY value ASC) tags_str
FROM recent_articles
LEFT JOIN tags_by_article USING(article_id),
  json_each(tags)
WHERE EXISTS (
  SELECT 1
  FROM json_each(tags)
  WHERE json_each.value LIKE :tag OR :tag IS NULL
)
GROUP BY recent_articles.article_id
ORDER BY recent_articles.article_published_on desc
<% if @page %>
<%= paginate(page: @page, per_page: @per_page) %>
<% end %>
